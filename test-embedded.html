<!DOCTYPE html>
<html>
<head>
    <title>Test Self-Contained SQLite Worker</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Self-Contained SQLite Worker Test</h1>
    <p>Testing the embedded WASM worker with no external dependencies.</p>
    
    <div id="log" class="log"></div>
    
    <script type="module">
        const log = document.getElementById('log');
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }
        
        async function testSelfContainedWorker() {
            try {
                logMessage('ğŸš€ Starting self-contained worker test...', 'info');
                
                // Load the WASM module (no-modules target)
                logMessage('ğŸ“¦ Loading WASM module...', 'info');
                const script = document.createElement('script');
                script.src = './pkg/sqlite_worker.js';
                document.head.appendChild(script);
                
                // Wait for wasm_bindgen to be available
                await new Promise((resolve, reject) => {
                    const checkWasm = () => {
                        if (typeof wasm_bindgen !== 'undefined') {
                            resolve();
                        } else {
                            setTimeout(checkWasm, 100);
                        }
                    };
                    checkWasm();
                    setTimeout(() => reject(new Error('WASM loading timeout')), 10000);
                });
                
                await wasm_bindgen('./pkg/sqlite_worker_bg.wasm');
                logMessage('âœ… WASM module loaded successfully', 'success');
                
                // Create database connection (this should spawn the self-contained worker)
                logMessage('ğŸ”§ Creating database connection...', 'info');
                const db = new wasm_bindgen.DatabaseConnection();
                logMessage('âœ… Database connection created', 'success');
                
                // Wait for worker initialization
                logMessage('â³ Waiting for worker to initialize...', 'info');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Test basic SQL operations
                logMessage('ğŸ“ Creating test table...', 'info');
                await db.query(`
                    CREATE TABLE IF NOT EXISTS test_table (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    )
                `);
                logMessage('âœ… Table created successfully', 'success');
                
                // Insert test data
                logMessage('ğŸ“ Inserting test data...', 'info');
                await db.query("INSERT INTO test_table (name) VALUES ('Self-contained test')");
                await db.query("INSERT INTO test_table (name) VALUES ('No external files!')");
                logMessage('âœ… Data inserted successfully', 'success');
                
                // Query data
                logMessage('ğŸ” Querying data...', 'info');
                const result = await db.query("SELECT * FROM test_table ORDER BY id");
                const data = JSON.parse(result);
                logMessage(`âœ… Query successful! Found ${data.length} rows:`, 'success');
                
                data.forEach((row, index) => {
                    logMessage(`  Row ${index + 1}: ${JSON.stringify(row)}`, 'info');
                });
                
                // Test that no external files are needed
                logMessage('ğŸ”’ Verifying no external dependencies...', 'info');
                logMessage('âœ… Test completed successfully!', 'success');
                logMessage('ğŸ‰ The worker is truly self-contained - no external files needed!', 'success');
                
            } catch (error) {
                logMessage(`âŒ Test failed: ${error.message}`, 'error');
                logMessage(`Stack: ${error.stack}`, 'error');
            }
        }
        
        // Start the test
        testSelfContainedWorker();
    </script>
</body>
</html>